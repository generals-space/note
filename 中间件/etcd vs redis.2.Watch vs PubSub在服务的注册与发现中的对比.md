# etcd vs redis.2.Watch vs PubSub在服务的注册与发现中的对比

参考文章

1. [在微服务架构中是否可用 redis 代替 etcd?](https://www.v2ex.com/t/520367?p=1)
    - 题主的问题问出了我长久的疑惑, 而答者对redis/etcd在微服务面前的优劣解释的非常清楚, 值得阅读.
2. [在微服务架构中Redis为什么不能取代Etcd？](https://www.xinran001.com/php/26.html)
    - 对etcd/redis的优劣做了总结性陈述.

## 疑问

> `etcd`是一个开源的、分布式的键值对数据存储系统, 提供共享配置、服务的注册和发现. 

以上是`etcd`的介绍. 关于共享配置, `redis`可以实现, 如果从高可用的角度`redis`现在也有 `cluster`集群方案. 

服务的注册和发现, `etcd`利用了其租约特性, 我认为`redis`也可以实现类似逻辑. 

我在网上也有搜到`redis`做服务发现和注册的方案, 但似乎没引起大家的注意. 

希望有大佬解答一下我的疑惑, 如果用`redis`去做会存在什么问题和风险? 

## 回答

简单从以下几个方面说一下`redis`为啥在微服务中不能取代`etcd`: 

1. `redis`没有版本的概念, 历史版本数据在大规模微服务中非常有必要, 对于状态回滚和故障排查, 甚至定锅都很重要;
2. `redis`的注册和发现目前只能通过`pub/sub`来实现(`etcd`中是`watch`), 这两个命令完全不能满足生产环境的要求.
    - `redis`的`pub/sub`在断线重连之后无法将历史数据再推送给client.
3. `etcd`在 2.+ 版本时, `watch`到数据后, 官方文档均建议再`get`一次, 因为会存在数据延迟, `3.+`版本不再需要, 可想`redis`的`pub/sub`能否达到此种低延迟的要求.
4. 楼主看到的微服务架构应该都是将`etcd`直接暴露给`client`和`server`的, `etcd`的性能摆在那, 能够承受多少的`c/s`直连呢, 更好的做法应该是对`etcd`做一层保护, 当然这种做法会损失一些功能;
5. `redis`和`etcd`的集群实现方案是不一致的. 
    - `etcd`采用的是`raft`协议, 一主多从, 只能写主, 写入数据需要多数节点应答, 确认后才会将数据返回给客户端. 底层采用`boltdb`作为`k/v`存储, 直接落盘(写入硬盘);
    - `redis`的持久化方案有`aof`和`rdb`, 这两种方案在宕机的时候都或多或少的会丢失数据(不符合CAP中的C);

总结

`redis`从来没有想过抢`etcd`在服务注册和发现的饭碗, 目前的架构来说也抢不动, 在缓存方面目前在性能和功能也无出其右; 

`etcd`只关注在服务注册与发现方面, 非要当做`k/v`存储来用（丢弃 watch 特性而言）也可以用, 性能也不错, 但只能说你选错对象了;

微服务架构中选择哪种技术, 取决于技术决定人的规划理想, 非要说`redis`不行当然也是错的, 不考虑服务规模和性能需求, 用 `mongodb`也能搞, `mongodb 3.6+`版本也有个`oplog watch`的功能.

------

配置管理/服务发现 需要高可用和强一致性(CAP中的C), 从上面可以看出, Redis并不具备该特性. 

Redis有着优秀的并发吞吐能力, 在web应用中, Redis大多数当缓存, 队列使用, 缓解数据库压力. 
