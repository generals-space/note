# SQL情境分析之按时间分段查询

参考文章

1. [sql查询技巧，按时间分段进行分组，每半小时一组统计组内记录数量](https://www.cnblogs.com/wang3680/p/6056882.html)

我遇到的场景是查询某表当天记录各时间段的平均值, 每3个小时一组.

参考文章1中按照分钟数计算然后除以30的思路给了我很大启发.

表记录内容大致如下

```sql
  id  |          created_at           | temperature
------+-------------------------------+-------------
 1439 | 2019-01-23 06:31:55.830692+00 |        18.1
 1438 | 2019-01-23 06:21:12.401214+00 |        19.6
 1437 | 2019-01-23 06:11:13.565703+00 |        21.5
 1436 | 2019-01-23 03:01:22.463949+00 |          16
 1435 | 2019-01-23 02:30:28.282441+00 |        16.2
 1434 | 2019-01-23 02:00:14.522178+00 |        11.8
 1433 | 2019-01-23 01:40:29.412115+00 |        10.4
 1432 | 2019-01-22 23:50:26.66155+00  |         3.9
 1431 | 2019-01-22 23:29:47.559969+00 |         4.2
 1430 | 2019-01-22 20:39:49.933248+00 |         5.5
(10 rows)
```

最后写出来的sql如下

```sql
select
b.time_part as section,
avg(a.temperature) as temperature
from my_table as a inner join (
    select id, ceiling(date_part('hour', created_at) / 3) as time_part from my_table
    where created_at > date_trunc('day', now())
) as b on a.id = b.id group by b.time_part;
```

查询结果如下

```sql
 section |     temperature
---------+---------------------
       1 | 13.6000000000000000
       2 | 19.7333333333333333
(2 rows)
```

> 其实sql写起来挺简单的(除了时区问题搞了半天之外), 主要是思路.