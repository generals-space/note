# 面向程序员的数据库访问性能优化法则

原文链接

[面向程序员的数据库访问性能优化法则](https://blog.csdn.net/yzsind/article/details/6059209)

## 1. 客户端多进程并行访问

多进程并行访问是指在客户端创建多个进程(线程). 每个进程建立一个与数据库的连接. 然后同时向数据库提交访问请求. 当数据库主机资源有空闲时. 我们可以采用客户端多进程并行访问的方法来提高性能. 如果数据库主机已经很忙时. 采用多进程并行访问性能不会提高. 反而可能会更慢. 所以使用这种方式最好与DBA或系统管理员进行沟通后再决定是否采用. 

例如: 

我们有10000个产品ID. 现在需要根据ID取出产品的详细信息. 如果单线程访问. 按每个IO要5ms计算. 忽略主机CPU运算及网络传输时间. 我们需要50s才能完成任务. 如果采用5个并行访问. 每个进程访问2000个ID. 那么10s就有可能完成任务. 

那是不是并行数越多越好呢. 开1000个并行是否只要50ms就搞定. 答案肯定是否定的. 当并行数超过服务器主机资源的上限时性能就不会再提高. 如果再增加反而会增加主机的进程间调度成本和进程冲突机率. 

以下是一些如何设置并行数的基本建议: 

如果瓶颈在服务器主机. 但是主机还有空闲资源. 那么最大并行数取主机CPU核数和主机提供数据服务的磁盘数两个参数中的最小值. 同时要保证主机有资源做其它任务. 

如果瓶颈在客户端处理. 但是客户端还有空闲资源. 那建议不要增加SQL的并行. 而是用一个进程取回数据后在客户端起多个进程处理即可. 进程数根据客户端CPU核数计算. 

如果瓶颈在客户端网络. 那建议做数据压缩或者增加多个客户端. 采用map reduce的架构处理. 

如果瓶颈在服务器网络. 那需要增加服务器的网络带宽或者在服务端将数据压缩后再处理了. 

## 2. 数据库并行处理

数据库并行处理是指客户端一条SQL的请求. 数据库内部自动分解成多个进程并行处理. 如下图所示: 

![](https://gitee.com/generals-space/gitimg/raw/master/edea900dad49f3ba9bab0f7b1f60c067.jpg)

并不是所有的SQL都可以使用并行处理. 一般只有对表或索引进行全部访问时才可以使用并行. 数据库表默认是不打开并行访问. 所以需要指定SQL并行的提示. 如下所示: 

```sql
select /*+parallel(a,4)*/ * from employee;
```

并行的优点: 

1. 使用多进程处理. 充分利用数据库主机资源(CPU,IO). 提高性能. 

并行的缺点: 

1. 单个会话占用大量资源. 影响其它会话. 所以只适合在主机负载低时期使用；
2. 只能采用直接IO访问. 不能利用缓存数据. 所以执行前会触发将脏缓存数据写入磁盘操作. 

注: 

1、并行处理在OLTP类系统中慎用. 使用不当会导致一个会话把主机资源全部占用. 而正常事务得不到及时响应. 所以一般只是用于数据仓库平台. 
2、一般对于百万级记录以下的小表采用并行访问性能并不能提高. 反而可能会让性能更差. 
