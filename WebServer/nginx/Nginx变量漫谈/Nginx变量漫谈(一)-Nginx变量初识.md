# Nginx变量漫谈(一)-Nginx变量初识

原文链接

[Nginx变量漫谈](http://blog.sina.com.cn/s/articlelist_1834459124_1_1.html)

个人对其章节进行重新划分, 使之更易阅读. 原作者声明不允许转载, 所以本文仅当作个人笔记, 不接受任何评论. 请到原作者博客发表见解.

## 1.1 基本认识

### 1.1.1 引言

Nginx的配置文件使用的就是一门微型的编程语言, 许多真实世界里的Nginx配置文件其实就是一个一个的小程序. 当然, 是不是"图灵完全的"暂且不论, 至少据我观察, 它在设计上受`Perl`和`Bourne Shell`这两种语言的影响很大. 在这一点上, 相比Apache和Lighttpd等其他Web服务器的配置记法, 不能不说算是Nginx的一大特色了. 既然是编程语言, 一般也就少不了"变量"这种东西(当然, `Haskell`这样奇怪的函数式语言除外了).

熟悉`Perl`, `Bourne Shell`, `C/C++`等命令式编程语言的朋友肯定知道, 变量说白了就是存放"值"的容器. 而所谓"值", 在许多编程语言里, 既可以是`3.14`这样的数值, 也可以是`hello world`这样的字符串, 甚至可以是像数组, 哈希表这样的复杂数据结构. 然而, 在Nginx配置中, 变量只能存放一种类型的值, 因为也只存在一种类型的值, 那就是字符串.

比如我们的`nginx.conf`文件中有下面这一行配置:

```
set $a "hello world";
```

这里使用了标准`ngx_rewrite`模块的`set`配置指令对变量`$a`执行了赋值操作. 特别地, 我们把字符串`hello world`赋给了它. 我们看到, Nginx变量名前面有一个'$'符号, 这是记法上的要求. 所有的Nginx变量在Nginx配置文件中引用时都须带上$前缀.这种表示方法和`Perl`, `PHP`这些语言是相似的.

### 1.1.2 变量插值

虽然$这样的变量前缀修饰会让正统的Java和C#程序员不舒服, 但这种表示方法的好处也是显而易见的, 那就是可以直接把变量嵌入到字符串常量中以构造出新的字符串:

```
set $a hello;
set $b "$a, $a";
```

这里我们通过已有的Nginx变量`$a`的值, 来构造变量`$b`的值, 于是这两条指令顺序执行完之后, `$a`的值是`hello`, 而`$b`的值则是`hello, hello`.这种技术在Perl世界里被称为`变量插值(variable interpolation)`, 它让专门的字符串拼接运算符变得不再那么必要. 我们在这里也不妨采用此术语.

## 1.2 实例分析

### 1.2.1

我们来看一个比较完整的配置示例:

```
server {
    listen 8080;

    location /test {
        set $foo hello;
        echo "foo: $foo";
    }
}
```

这个例子省略了`nginx.conf`配置文件中最外围的`http`配置块以及`events`配置块. 使用`curl`这个HTTP客户端在命令行上请求这个`/test`地址, 我们可以得到

```
$ curl 'http://localhost:8080/test'
foo: hello
```

这里我们使用第三方`ngx_echo`模块的`echo`配置指令将`$foo`变量的值作为当前请求的响应体输出. 我们看到, echo配置指令的参数也支持"变量插值". 不过, 需要说明的是, **并非所有的配置指令都支持"变量插值"**.事实上, 指令参数是否允许"变量插值", 取决于该指令的实现模块.

### 1.2.2

如果我们想通过`echo`指令直接输出含有`"美元符"($)`的字符串, 那么有没有办法把特殊的`$`字符给转义掉呢? 答案是否定的(至少到目前最新的Nginx稳定版1.0.10). 不过幸运的是, 我们可以绕过这个限制, 比如**通过不支持"变量插值"的模块配置指令专门构造出取值为$的Nginx变量, 然后再在echo中使用这个变量**.

看下面这个例子:

```
geo $dollar {
    default "$";
}

server {
    listen 8080;

    location /test {
        echo "This is a dollar sign: $dollar";
    }
}
```

测试结果如下:

```
$ curl 'http://localhost:8080/test'
This is a dollar sign: $
```

这里用到了标准模块`ngx_geo`提供的配置指令`geo`来为变量`$dollar`赋予字符串'$', 这样我们在下面需要使用美元符的地方, 就直接引用我们的`$dollar`变量就可以了. 其实`ngx_geo`模块最常规的用法是**根据客户端的IP地址对指定的Nginx变量进行赋值**, 这里只是借用它以便"无条件地"对我们的`$dollar`变量赋予"美元符"这个值.

### 1.2.3

在"变量插值"的上下文中, 还有一种特殊情况, 即当引用的变量名之后紧跟着变量名的构成字符时(比如后跟字母, 数字以及下划线), 我们就需要使用特别的记法来消除歧义, 例如:

```
server {
    listen 8080;

    location /test {
        set $first "hello ";
        echo "${first}world";
    }
}
```

这里, 我们在`echo`配置指令的参数值中引用变量`$first`的时候, 后面紧跟着`world`这个单词. 所以如果直接写作`"$firstworld"`, 则 Nginx"变量插值"计算引擎会将之识别为引用了变量`$firstworld`. 为了解决这个难题, Nginx的字符串记法支持使用花括号在$之后把变量名围起来, 比如这里的`${first}`.

上面这个例子的输出是:

```
$ curl 'http://localhost:8080/test'
hello world
```
