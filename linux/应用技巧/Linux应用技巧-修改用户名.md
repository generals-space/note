# Linux修改用户名

<!tags!>: <!linux应用技巧!>

原文链接

[Linux系统中修改用户名的两种方案整理](http://www.jianshu.com/p/11cd3564855c)

在安装系统或创建服务的时候，经常会无意识的随便起个用户名，后面发现该用户名不好或因为环境需要须重起个用户名. 经过查找资料和亲自测试发现有两种方案可选：手动修改和使用`usermod`等命令自动修改。

## 1. 手动修改各个关联用户文件

原来存在用户`test1`, 现在需要将其修改为`test2`, 修改步骤如下.

### 1. 以root身份登录

这些系统文件的修改需要root权限，这里不管是原root用户登录还是普通用户切换到root下都可以，只要有修改权限就行。

### 1.2 /etc/passwd与/etc/group

#### 1.2.1 /etc/passwd

本来的用户名为`test1`，`/etc/passwd`中对应行内容如下.

```
test1:x:1001:1001::/home/test1:/bin/bash
```

现在想修改为`test2`，则要修改第1列`test1`为`test2`, 第7列用户主目录为`/home/test1`;

第3,4列`1001:1001`中的第二个1001为组标识号, 即`gid`，这里不用修改，因为我们的目的不是新增加组而是把更改用户名和组名. 所以`gid`号可以保持不变, 而将原来的组名改掉即可.

#### 1.2.2 /etc/group

这里要修改的是`gid`与组名的对应关系. 原来的文件内容为

```
test1:x:1001:
```

将第1列的`test1`修改为`test2`, 这样`test2`的gid就是1001了.

#### 1.2.3 修改原用户主目录属主

将`/home/test1`重命名为`/home/test2`即可, 即只要简单地执行`mv /home/test1 /home/test2`. 不用显式进行属主修改, `/home/test1`目录及其下的所有文件的所属用户及用户组都会自动修改好, 不需要手动执行`chown -R`.

### 1.3 修改/etc/shadow与/etc/gshadow文件

#### 1.3.1 /etc/shadow


```
test1:!!:17111:0:99999:7:::
```

修改第1列`test1`为`test2`. 不修改这个可能无法登陆系统, 非常重要.

#### 1.3.2 /etc/gshadow

```
test1:!::
```

第1列`test1`修改为`test2`.

----

用户密码未修改, 使用新用户名与原用户密码即可登录.

**上面的几个步骤缺一不可，操作失误很可能导致无法登入系统，认真完成上面的5个步骤重启系统后即可修改成功。**

### 1.4 /etc/sudoers文件

如果原用户在`/etc/sudoers`中配置了root命令权限, 还需要将这个文件中的原用户名修改掉, 否则新用户执行相应的root命令时会出现`test2 is not in the sudoers file. This incident will be reported.`的错误.

## 2. 使用usermod/groupmod命令修改

首先介绍下usermod命令的基本用法：

```
usermod [-LU][-c <备注>][-d <登入目录>[-m]][-e <有效期限>] [-f <缓冲天数>][-g <群组>][-G <群组>][-l <帐号名称>][-s <shell>] [-u <uid>[-o]] [用户帐号]
```

描述：

usermod命令会参照你命令行中指定的部分修改系统文件。下面为`usermod`可选用的参数。

- -c <备注>: 更新/etc/passwd中的注解栏。

- -d <登入目录>: 更新使用者的用户目录。如果给定`-m`选项，使用者旧目录会搬到新的目录去，如新目录不存在则会自动创建。

- -e <有效期限>: 使用者帐号的有效期限。日期格式为`MM/DD/YY`.

- -f <缓冲天数>: 帐号过期几日后永久停权。当值为0时帐号则立刻被停权。而当值为-1时则关闭此功能。预设值为-1。

- -g <群组>: 更新使用者新的起始登入群组。群组名须已存在。群组ID必须参照既有的的群组。群组ID预设值为1。

- -G <群组>: 定义使用者为一堆groups的成员。群组名同-g选项的限制。如果使用者现在的群组不再此列，则将使用者由该群组中移除。

- -l <帐号名称>: 变更使用者login时的名称为login_name，即修改用户登录名。其于不变。特别是，使用者目录名应该也会跟着更动成新的登入名。

- -s <shell>: 指定新登入shell。如此栏留白，系统将选用系统预设shell。

- -u <uid>: 用户id。必须为唯一的ID值，除非用`-o`选项。数字不可为负值。预设为最小不得小于99而逐次增加。0~99传统上是保留给系统帐号使用。使用者目录树下所有的档案目录其userID会自动改变。放在使用者目录外的档案则要自行手动更动。

**警告**

`usermod`不允许你改变正在线上的使用者帐号名称。当`usermod`用来改变`uid`，必须确认这名user没在电脑上执行任何程序，否则会报`usermod: user xxx is currently logged in`错误。因此必须root用户登录或者其他用户登录然后切换到root身份，而不能在待修改用户下切换至root进行修改。

修改用户名步骤如下, 基本上与第一种方法的步骤吻合：

以原用户名`test2`修改为`test1`用户名为例：

### 2.1 以root身份登录

### 2.2 

```
$ usermod -l test2 test1
```

这条命令做了两件事：

1. 将`/etc/passwd`下的用户名列从`test2`修改为`test1`，其他部分不变.

2. 将`/etc/shadow`下的用户名列从`test2`修改为`test1`，其他部分不变.

### 2.3 

```
$ usermod -c test1 test1
```

相当于将`/etc/passwd`下`test1`所在行的注解栏(第5列)修改为`test1`，其他部分不变.

### 2.4 

```
$ groupmod -n hadoop seed
```

将原来的用户组`test2`修改为`test1`，只修改组名，`gid`不变，相当于修改了文件`/etc/group`和`/etc/gshadow`.

### 2.5

```
$ usermod -md /home/hadoop hadoop
```

相当于做了两件事：

1. 将`/etc/passwd`下的用户主目录修改为`/home/test1`，其他部分不变.

2. 将原来的用户目录`/home/test2`修改为新的用户目录`/home/test1`.