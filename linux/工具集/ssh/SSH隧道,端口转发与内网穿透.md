# SSH隧道, 端口转发与内网穿透

参考文章

[SSH隧道技术简介](http://blog.sina.com.cn/s/blog_6ca2bddf0100rljn.html)

有如下情境:

- 公司不让我们上某些网站, 限制了网址, IP甚至端口. 

- 公司不让我们看某种类型的信息, 并且通过**对内容进行过滤**, 当访问内容中出现这类信息, 链接就中断了. 

- 我希望能够在家里访问在公司的电脑（写程序, 查数据, 下电影）, 但没有VPN权限, 无法连接. 

- 防火长城禁止访问谷歌...

带着这些问题, 我们先了解SSH隧道是什么. 

## 1. 什么是SSH隧道

首先看下面这张图, 我们所面临的大部分情况都和它类似. 

![](https://gitee.com/generals-space/gitimg/raw/master/c9e1370f79ab53ec852d15bf7b4ec617.jpeg)

`公司电脑A`, 通过公司带有防火墙功能的路由器访问互联网（当然可能还有交换机什么的在中间连接, 但是在我们的情境中交换机并不起什么关键性的作用）. 

`公司防火墙B`禁止我们访问`目标服务器C`.

我们拥有一台`中转服务器D`可以访问`服务器C`.

在公司可以访问`中转服务器D`.

------

现在我们清楚地知道了自己所处的网络环境. 并且不难理解我们在公司无法访问那个服务器的原因是: 在线路`A -> B -> C`上`A - C`之间的防火墙`B`屏蔽了对目标服务器`C`的访问. 与此同时, 我们也很快注意到, 线路`A -> B -> D`之间和`D -> C`之间是不受阻碍的. 因此我们可以通过服务器C建立一个通道`A -> B -> D -> C`, 从而访问到服务器B上的数据. 

这条通道可以用**很多技术**来建立, 使用SSH服务器来建立的这样的通道, 被称为`SSH隧道`. 

使用`ssh`工具建立的隧道有三种用法:

1. Local: 本地端口映射

2. Remote: 远程端口映射

3. Socks服务器

## 2. 隧道建立方法及典型使用场景

### 2.1 本地端口映射

#### 2.1.1 流程分析

为了能在公司访问服务器C的`80`端口(当然也可以是其他端口), 我们在公司电脑A上选择一个端口`8080`, 通过ssh工具建立与我们作为中转服务器C的连接, 并将这个连接指向目标服务器B的`80`端口. 这样, 我们访问本地的`8080`, 就相当于访问了C的`80`.

具体流程是

1. 首先公司电脑A建立与中转服务器D的SSH连接, 这要求我们拥有D的ssh登录权限. 在这个过程中, A将选择一个本地随机端口发出ssh请求, 通过防火墙NAT转换后连接到中转服务器C的22端口, 最终与C建立连接的来源为**公司防火墙的出口IP与随机端口**.

2. 本地电脑A访问`8080`端口, ssh工具会将发送到这个端口的数据通过建立好的ssh连接传输到D的`22`端口, 因为通过在C上抓包观察到与公司出口IP建立的连接只有这个ssh连接, 没有其他端口.

3. D会将通过ssh连接发来的数据进行解析, 把本来访问的是原来本地电脑A的`8080`端口的请求转发给到C的`80`端口. 

4. 之后C的`80`端口对来自D的请求的响应并将通过原来的路径返回.

#### 2.1.2 命令示例

我们在`公司电脑`A上, 使用如下命令实现上述目标

```
ssh -N -f -L 8080:目标服务器IP:80 root@中转服务器IP
```

- -N 告诉SSH客户端, 这个连接不需要执行任何命令. 仅仅做端口转发

- -f 告诉SSH客户端在后台运行

- -L 做本地映射端口. 之后的`8080:目标服务器IP:80`, 8080是本地ssh监听端口, `目标服务器:80`就是我们在公司内网本来无法访问的那些服务器. 不只是http协议, 还可以是比较底层的TCP协议, 所以对mysql的3306端口的请求也是可以转发的.

> 在这条命令成功执行之后, 我们已经具有绕过公司防火墙的能力, 并且成功访问到了我们的目标服务器了.

### 2.2 远程端口映射

#### 2.2.1 流程分析

我们一般无法在公司外部访问内网的电脑, 公司本身的业务中, 如果需要内网服务器面对公网提供服务, 需要网络管理员做对应的外网映射, 而普通员工禁止这样的操作的. 

为了能在家里访问在公司被保护在防火墙之后的电脑, 我们可以使用ssh工具的远程端口映射功能.

我们注意到, 虽然`D -> B -> A`这个方向的连接是不通的, 但反过来`A -> B -> D`的连接是可以的, 那么我们可以利用一条已经连接好的`A -> B -> D`方向的连 接来完成`D -> B -> A`方向的访问.

#### 2.2.2 命令示例

我们在公司电脑A上搭建并启动`sshd`服务, 正常情况下在公司外是无论如何都没有办法访问到这个内网主机的22端口的. 然后在A上执行如下命令.

```
ssh -N -f -R 2222:127.0.0.1:22 root@中转服务器IP
```

`-N`与`-f`的用法与上面本地端口映射的相同, 不同的只有`-R`选项.

`-R`表示做远程端口映射, `2222:127.0.0.1:22`表示, 映射中转服务器D的2222端口到公司电脑A的22端口, 可以理解为是公司电脑A在D服务器上创建的监听端口. 22是映射到A的22端口, 其实也可以是别的. `D:2222 -> A:22`这条隧道建立在本次ssh连接之上.

上述命令使用ssh工具从公司电脑A连接到中转服务器D的`22`端口, 然后在中转服务器上选择`2222`端口, 将这个`2222`端口通过这条ssh连接映射到电脑A的`22`端口. 这种方式实现的映射方法叫做远程端口映射. 

然后我们就可以登录中转服务器D然后再次ssh连接到D本地的2222端口, 就相当于访问了A的22端口并实现登录了.

> 这个和`反弹shell`有异曲同工之妙啊...

### 2.3 Socks服务器

#### 2.3.1 流程分析

有了上面两种方法, 无论是公司防火墙还是GFW防火墙都可以穿透了. 但是, 我在局域网中访问的受限网站很多...咳, `本地端口映射`这种一个网站一个网站的添加其80端口显然不明智. 正好, SSH工具提供了通过SSH隧道建立SOCKS服务器的功能(关于SOCKS服务器, 可以简单地理解为更为底层的代理服务器).

首先在电脑A上建立与中转服务器D的ssh连接, 建立该连接的同时, ssh工具在本地监听一个端口, 比如`1080`. 我们在使用电脑A时, 将需要穿墙的请求全部发送到这个端口, ssh工具会将这些请求通过隧道传输到中转服务器D并转发出去, 而不是像`本地端口映射`那样转发到指定IP和端口. 

#### 2.3.2 命令示例

```
ssh -N -f -D 1080 root@中转服务器IP
```

`-D`选项指定一个本地的动态转发端口, 所有发送到此端口的请求都会被发送到中转服务器并转发出去. 之所以叫**动态转发**, 是因为与2.1节的本地端口映射相比, 它并不限制目标服务器的地址与端口, 因为灵活了许多.

> 通过SSH建立的SOCKS服务器使用的是`SOCKS5`协议, 在为应用程序设置SOCKS代理的时候要特别注意.

------

> 个人觉得, 只有2.2节的远程端口映射才算得上是`内网穿透`, `2.1`与`2.3`其实是socket层面的代理(端口转发)而已.

> 上述3种连接可靠的, 即其中一方断开, 另一方也随之关闭, 不会存在脑裂的情况.