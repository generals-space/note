# FTP主动模式和被动模式

参考文章

1. [FTP主动模式和被动模式的比较](http://jackiechen.blog.51cto.com/196075/193883/)

2. [FTP主动模式和被动模式的区别](http://www.cnblogs.com/xiaohh/p/4789813.html)

FTP是仅基于TCP的服务, 不支持UDP. 与众不同的是FTP使用2个端口, 一个数据端口和一个命令端口(也可叫做控制端口). 通常来说这两个端口是21(命令端口)和20(数据端口). 但FTP工作方式的不同, **数据端口并不总是20**. 这就是主动模式与被动模式的最大不同之处.  

## 1. 主动模式(active mode)

主动模式的工作流程为: 客户端从一个任意的非特权端口`N`(`N` > 1024)连接到FTP服务器的命令端口(就是21端口). 然后客户端开始监听端口`N + 1`, 并发送FTP命令`port N+1`到FTP服务器. 接着服务器会从它自己的数据端口(20)连接到客户端指定的数据端口(N + 1). 

针对FTP服务器前面的防火墙来说, 需要配置以下规则才能支持主动方式FTP:     

1. 允许来自客户端的, 任何大于1024的端口到FTP服务器的21端口. (客户端初始化的连接) 

2. 允许FTP服务器的21端口接连到外部大于1024的端口.  (服务器响应客户端的控制端口) 

3. 允许FTP服务器的20端口接连到外部大于1024的端口. (服务器端初始化数据连接到客户端的数据端口)

4. 允许外部大于1024端口到FTP服务器的20端口(客户端发送ACK响应到服务器的数据端口) 

## 2. 被动模式(passive mode)

为了解决服务器发起到客户的连接的问题, 人们开发了另外一种不同的FTP连接方式. 这就是所谓的**被动模式**, 或者叫做`PASV`, **当客户端通知服务器它处于被动模式时才启用**. 

在被动模式中, 命令连接和数据连接都由客户端发起, 这样就可以解决从服务器到客户端的数据端口的入方向连接被防火墙过滤掉的问题, 但同样的, FTP服务器的防火墙要同时允许20和21两个端口的连接.

当建立一个FTP连接时, 客户端打开两个任意的非特权本地端口(N > 1024和 N + 1). 第一个端口连接服务器的21端口, 但与主动方式的FTP不同, 客户端不会提交`PORT`命令并允许服务器来回连它的数据端口, 而是提交`PASV`命令. 这样做的结果是服务器会开启一个任意的非特权端口`P`(P > 1024), 并发送`PORT P`命令给客户端. 然后客户端发起从本地端口`N + 1`到服务器的端口`P`的连接用来传送数据.   

对于服务器端的防火墙来说, 需要配置以下规则:     

1. 允许来自任何大于1024的端口到服务器的21端口(客户端初始化的连接)  

2. 允许服务器的21端口建立到外部任何大于1024的端口的连接(服务器响应到客户端的控制端口的连接) 

3. 允许来自任何大于1024端口到服务器的大于1024端口(客户端初始化数据连接到服务器指定的任意端口)

4. 允许服务器的大于1024端口建立到远程的大于1024的端口的连接(服务器发送ACK响应和数据到客户端的数据端口)

## 3. 总结

以上关于主动和被动FTP的解释, 可以简单概括为以下两点: 

1、主动FTP:   

    命令连接: 客户端 >1024端口 -> 服务器 21端口  

    数据连接: 客户端 >1024端口 <- 服务器 20端口 

2、被动FTP:  

    命令连接: 客户端 >1024端口 -> 服务器 21端口 

    数据连接: 客户端 >1024端口 -> 服务器 > 1024端口

采用哪一种模式由ftp客户端决定, 但是行为上是服务器端才有所区别.

主动与被动FTP优缺点: 

主动FTP对FTP服务器的管理有利, 但对客户端的管理不利. 因为FTP服务器企图与客户端的高位随机端口建立连接, 而这个端口很有可能被客户端的防火墙阻塞掉. 如果客户端没有防火墙的需求, 只有服务器端才有, 则这种方式是推荐的, 因为服务器端的防火墙只要打开21端口就行了(没错, 只用打开21端口, 20端口是服务器端主动建立的, 不会被对外防火墙屏蔽).

被动FTP对FTP客户端的管理有利, 但对服务器端的管理不利. 因为客户端要与服务器端建立两个连接, 其中一个连到一个高位随机端口, 而这个端口很有可能被服务器端的防火墙阻塞掉. 

## 4. ftp客户端模式选择

### 4.1 ftp命令

- -A 使用主动模式

- -p 使用被动模式