# GCC内联汇编(AT&T)

参考文章

1. [内联汇编](http://blog.csdn.net/liuqiaoyu080512/article/details/8457528)

用汇编编写的程序虽然运行速度快, 但开发速度非常慢, 效率也很彽. 如果只是想对关键代码段进行优化, 或许更好的办法是将汇编指令嵌入到C程序中, 从而充分利用高级语言和汇编语言各自的特点. 但一般来讲, 在C代码中嵌入汇编语句要比"纯粹"的汇编语言代码复杂得多, 因为需要解决**如何分配寄存器**, 以及**如何与C代码中的变量相结合**问题. 

## 1. 格式简述

GCC提供了很好的内联汇编支持, 最基本的格式为: 

```c
__asm__("asm statement");
```

但通常嵌入到C代码中的汇编语句很难做到与其他部分没有关系, 如C语言中变量的引用等, 因此更多时候需要利用到完整的内联汇编格式: 

```
__asm__(
    "汇编语言模板"
    :输出部分
    :输入部分
    :破坏性描述部分
    );//注意结尾的分号
```
其中汇编语言模板为必选, 其余三项可以为空. **如果输出/输入部分为空, 其前面的冒号也不可省略**, 如: `__asm__("汇编语句...":::)`. 

## 2. 示例代码

```
 #include <stdio.h>
 int main()
 {
         int a = 1;
         int b = 2;
         int c = 0;
 
         __asm__ __volatile__(
                 "mov %1,%%eax;"
                 "mov %2,%%ebx;"
                 "add %%ebx,%%eax;"
                 "mov %%eax,%0;"
                 :"=r"(c)
                 :"r"(a),"r"(b)
                 :
         );
         printf("a + b = %dn", c);
         return 0;
 }
 ```

上述代码可用GCC按照C程序正常编译

## 3. .语法细节

### 3.1 汇编语言模板(asm statement)

**这里是内联汇编的主体部分, 由一条条汇编语句组成**. 

语句之间用`;`, `\n`或`\t`分隔, 并且每行由双引号""环绕;

用加上`%`前缀的数字可以表示**对C语言变量的引用**, 称为占位符, 但需要从输出和输入部分声明, 如上述代码13,14行, 将c, a, b传入, 在模板里即可用`%0`, `%1`, `%2`引用. 其中`%0`表示c, `%1`表示`a`, `%2`表示`b`. 可以观察出声明的顺序与`%n`中数字序号的联系. 

寄存器前面要加两个`%`, 避免与占位符产生混淆;

### 3.2 输出部分

**可以将汇编指令的结果与C语言变量之间建立联系**. 

规定C代码中输出变量与汇编指令中操作数进行结合的条件, 每个条件称为一个`约束`, 可以包含多个约束, 相互之间用逗号分隔即可. 

每个输出约束以'='开始, 然后紧跟一个**对操作数类型进行说明的字**, 最后是与哪个变量相结合的约束, 意为**对将C代码变量可能存放在哪一个寄存器进行说明**. (**上述代码13行, 指变量c可以存放在r(任意寄存器中)中**)

凡是与输出部分中说明的操作数相结合的寄存器或操作数本身, 在执行完内联的汇编代码后均不保留执行前的内容, 这是GCC在调度寄存器时所使用的依据. 

### 3.3 输入部分

相似于输出部分, 但不带'='. 

如果一个输入约束要求使用寄存器, 则GCC在预处理时就会为之分配一个寄存器, 并插入必要的指令将操作数装入该寄存器. 

与输入部分中说明的操作数结合的寄存器或操作数本身, 在执行完内联的汇编代码后也不保留执行之前的内容. 

### 3.4 破坏性描述部分

有时在进行某些操作时, 除了要用到进行数据输入和输出的寄存器外, 还要使用多个寄存器来保存中间计算结果, 这样就难免会破坏正常情况下原有寄存器的内容. 在破坏性描述部分中可以对汇编语句中可能用到的`寄存器/内存`进行说明, **以便GCC能够采用相应的措施(比如放弃对其中寄存器的使用)**. 

通知编译器我们使用了哪些寄存器, 由逗号相隔开的的字符串组成, 每个字符串描述一种情况, 一般是寄存器名, 还可能是'memory'. 比如"%eax", "%ebx", "memory"等. 

## 4. 扩展

输入输出部分中, 指令操作数(上述代码中用到了'r', 意为可以将C语言变量a, b, c放入任意通用寄存器)

![](https://gitee.com/generals-space/gitimg/raw/master/55505280bcf99d5520d8c118c05fef1c.png)